(function(a,r){typeof exports=="object"&&typeof module<"u"?r(exports):typeof define=="function"&&define.amd?define(["exports"],r):(a=typeof globalThis<"u"?globalThis:a||self,r(a.MLEWTracker={}))})(this,function(a){"use strict";const r="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let c=(n=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(n|=0));for(;n--;)e+=r[t[n]&63];return e};const h="mlew_tracker_";class o{static get(e){try{return localStorage.getItem(h+e)}catch{return null}}static set(e,t){try{localStorage.setItem(h+e,t)}catch{}}static remove(e){try{localStorage.removeItem(h+e)}catch{}}static getJson(e){const t=this.get(e);if(!t)return null;try{return JSON.parse(t)}catch{return null}}static setJson(e,t){try{this.set(e,JSON.stringify(t))}catch{}}}class d{constructor(e=30*60*1e3){this.sessionTimeout=e,this.sessionStart=Date.now();const t=o.getJson("session"),s=Date.now();t&&s-t.sessionStart<this.sessionTimeout?(this.sessionId=t.sessionId,this.sessionStart=t.sessionStart):(this.sessionId=c(),this.persistSession())}getSessionId(){return this.sessionId}getSessionDuration(){return Date.now()-this.sessionStart}refreshSession(){this.persistSession()}newSession(){this.sessionId=c(),this.sessionStart=Date.now(),this.persistSession()}persistSession(){o.setJson("session",{sessionId:this.sessionId,sessionStart:this.sessionStart})}}class f{constructor(e){this.queue=[],this.flushTimer=null,this.config={apiEndpoint:"http://localhost:3001",flushInterval:5e3,maxQueueSize:10,...e}}enqueue(e){this.queue.push(e),this.config.debug&&console.log("[MLEW Tracker] Event queued:",e),this.queue.length>=(this.config.maxQueueSize??10)?this.flush():this.flushTimer||this.scheduleFlush()}async flush(){if(this.queue.length===0)return;const e=this.queue.splice(0);this.clearFlushTimer(),this.config.debug&&console.log(`[MLEW Tracker] Flushing ${e.length} events`),await this.sendEvents(e)}scheduleFlush(){this.flushTimer=window.setTimeout(()=>{this.flush()},this.config.flushInterval)}clearFlushTimer(){this.flushTimer&&(window.clearTimeout(this.flushTimer),this.flushTimer=null)}async sendEvents(e){try{const t={applicationId:this.config.applicationId,events:e.map(v=>{const{applicationId:k,...w}=v;return w})},s={"Content-Type":"application/json"};this.config.apiKey&&(s["X-Api-Key"]=this.config.apiKey);const i=await fetch(`${this.config.apiEndpoint}/v1/events`,{method:"POST",headers:s,body:JSON.stringify(t)});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const u=await i.json();this.config.debug&&console.log("[MLEW Tracker] Events sent successfully:",u)}catch(t){console.warn("[MLEW Tracker] Failed to send events:",t)}}}class g{constructor(e){this.isEnabled=!1,this.handleClick=t=>{if(!this.isEnabled)return;const s=t.target,i=this.extractTrackingData(s);i&&this.tracker.trackClick(i.name,i.properties)},this.handlePageView=()=>{this.isEnabled&&this.tracker.trackView(window.location.pathname,{title:document.title,referrer:document.referrer})},this.handleFormSubmit=t=>{if(!this.isEnabled)return;const s=t.target,i=this.extractTrackingData(s);i&&this.tracker.track("form-submit",{formName:i.name,...i.properties})},this.tracker=e}enable(){this.isEnabled||(this.isEnabled=!0,this.setupEventListeners())}disable(){this.isEnabled&&(this.isEnabled=!1,this.removeEventListeners())}setupEventListeners(){document.addEventListener("click",this.handleClick),window.addEventListener("popstate",this.handlePageView),document.addEventListener("submit",this.handleFormSubmit),this.handlePageView()}removeEventListeners(){document.removeEventListener("click",this.handleClick),window.removeEventListener("popstate",this.handlePageView),document.removeEventListener("submit",this.handleFormSubmit)}extractTrackingData(e){return e.dataset.track!=="true"?null:{name:e.dataset.trackName||e.id||e.className||"unnamed-element",properties:{elementType:e.tagName.toLowerCase(),className:e.className,id:e.id,page:window.location.pathname,category:e.dataset.trackCategory,section:e.dataset.trackSection,type:e.dataset.trackType,...this.parseCustomDataAttributes(e)}}}parseCustomDataAttributes(e){const t={};for(const[s,i]of Object.entries(e.dataset))if(s.startsWith("track")&&s!=="track"&&s!=="trackName"){const u=s.replace("track","").toLowerCase();t[u]=i}return t}}class l{constructor(e){this.enabled=!0,this.version="1.0.0",this.config={apiEndpoint:"http://localhost:3001",autoTrack:!0,flushInterval:5e3,maxQueueSize:10,debug:!1,...e},this.sessionManager=new d,this.eventQueue=new f(this.config),this.autoTracker=new g(this);const t=o.get("userId");this.userId=t||void 0,this.config.autoTrack&&this.autoTracker.enable(),this.setupUnloadHandler(),this.config.debug&&console.log("[MLEW Tracker] Initialized:",this.config)}track(e,t){if(!this.enabled)return;const s=this.createEvent("custom",t,e);this.eventQueue.enqueue(s)}trackClick(e,t){if(!this.enabled)return;const s=this.createEvent("click",{elementName:e,...t});this.eventQueue.enqueue(s)}trackView(e,t){if(!this.enabled)return;const s=this.createEvent("view",{page:e,...t});this.eventQueue.enqueue(s)}setUserId(e){this.userId=e,o.set("userId",e),this.config.debug&&console.log("[MLEW Tracker] User ID set:",e)}setUserProperties(e){this.track("user-properties",e)}async flush(){await this.eventQueue.flush()}enable(){this.enabled=!0,this.config.autoTrack&&this.autoTracker.enable()}disable(){this.enabled=!1,this.autoTracker.disable()}isEnabled(){return this.enabled}getSessionId(){return this.sessionManager.getSessionId()}getUserId(){return this.userId}createEvent(e,t,s){const i=Date.now();return this.sessionManager.refreshSession(),{eventId:c(),applicationId:this.config.applicationId,applicationName:this.config.applicationName,eventType:s?"custom":e,timestamp:i,elementName:t==null?void 0:t.elementName,elementType:t==null?void 0:t.elementType,page:(t==null?void 0:t.page)||window.location.pathname,url:window.location.href,sessionId:this.sessionManager.getSessionId(),userId:this.userId,userAgent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight},properties:{...t,...s&&{customEventType:s}},createdAt:new Date(i).toISOString(),version:this.version}}setupUnloadHandler(){const e=()=>{this.eventQueue&&this.eventQueue.flush()};window.addEventListener("beforeunload",e),window.addEventListener("pagehide",e)}}const m={Tracker:l};a.Tracker=l,a.default=m,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=index.umd.js.map
